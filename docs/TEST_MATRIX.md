# Manual test matrix

| Área | Escenario | Pasos | Resultado esperado |
| --- | --- | --- | --- |
| Descubrimiento | Agente aparece en el panel | 1. Arrancar `server.omi_server`.<br>2. Iniciar un agente (`python client/client.py`).<br>3. Abrir `http://<server>:6969/` y forzar refresh. | El agente aparece en la vista **Clientes** con `online=true`, índice asignado y dirección IP detectada. |
| Cambio de servicio | Solicitar servicio MIDI | 1. En la vista **Dispositivos**, seleccionar el agente y solicitar `MIDI`.<br>2. Confirmar cuando llegue el `SERVICE_ACK` en logs. | La API responde `{"ok": true}`; el agente emite logs de transición y el servicio inicia (`logs/services/midi.log`). |
| Índice lógico | Reasignar índice desde el servidor | 1. Ejecutar `PUT /api/devices/<serial>` con `{"desired_service": null, "network": null}` para registrar el dispositivo.<br>2. Eliminar el registro vía `DELETE /api/devices/<serial>`.<br>3. Verificar en los logs que se envía `SET_INDEX` a agentes restantes. | El índice se reequilibra y cada agente confirma con `INDEX_ACK`. |
| Perfil de red | Registrar perfil deseado | 1. `PUT /api/devices/<serial>` con `"network": {"vlan_id": 20, "dhcp": true}`.<br>2. Confirmar en la base (`devices.network_profile`). | El perfil queda guardado y se registra en `server/logs/server.log`; el stub `NetworkManager` lo reconoce. |
| Handshake de red | Simular ACK desde agente | 1. Enviar `POST /api/devices/<serial>/network/ack` con `{"applied": true}`.<br>2. Revisar `server/logs/server.log`. | El servidor registra `ACK de red recibido` y responde `{"ok": true}`. |
| MIDI Web UI | Crear preset por pantalla LEARN | 1. Levantar la Web UI (`python servicios/MIDI/midiwebui.py`).<br>2. Entrar a `/add/learn`, mover control MIDI, aceptar ruta.<br>3. Confirmar que se crea registro y que el JS actualiza vista sin errores. | La ruta aparece en `OMIMIDI_map.json`, se vuelca a servidor (log en `midi.log`) y en panel se muestra el resumen de la ruta. |
| Sincronización de presets | Reiniciar con cambios | 1. Editar parámetros en `/settings` (p.e. puertos OSC) y guardar.<br>2. Observar pantalla de reinicio y esperar reconexión. | Se escribe `OMIMIDI_restart.flag`, el core reinicia y al volver la UI muestra la nueva configuración; logs indican reinicio exitoso. |
| Ping OSC | Enviar ping manual | 1. Desde la Web UI pulsar “Enviar ping OSC”.<br>2. Revisar `midi.log` y destino OSC. | Se registra `Ping OSC enviado` en logs; los targets reciben `/omimidi/ping`. |
| Persistencia | Reinicio de core | 1. Matar proceso `omimidi_core` mientras servicio está en ejecución.<br>2. Relanzar servicio (`python servicios/MIDI/service.py`). | Los ficheros temporales (`OMIMIDI_state.json`, etc.) se limpian al arranque y los últimos valores se conservan al rearmarse el mapa. |
