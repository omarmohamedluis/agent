# omi-Agent

Agente REST ligero para Raspberry Pi que permite gestionar roles, servicios y configuraciones de forma centralizada.

---

## ğŸš€ CaracterÃ­sticas principales
- API REST en **FastAPI**
- MÃ©tricas del sistema (CPU, RAM, temperatura, uptime)
- Control de servicios (`systemd`)
- GestiÃ³n de roles (`omimidi`, `omiosc`, `satellite`, `companion`, `standby`)
- Guardado de configuraciones en `/etc/omi/roles/`
- Reboot / Shutdown remoto
- Descubrimiento automÃ¡tico por **mDNS**

---

## ğŸ§° InstalaciÃ³n en Raspberry Pi

```bash
sudo apt update && sudo apt -y install python3 python3-pip python3-venv git avahi-daemon
mkdir -p ~/omi && cd ~/omi
git clone https://github.com/omarmohamedluis/agent.git
cd agent
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
ğŸ” Crear servicio systemd
bash
Copiar cÃ³digo
sudo tee /etc/systemd/system/omiagent.service >/dev/null <<'EOF'
[Unit]
Description=omiAgent REST
After=network-online.target
Wants=network-online.target

[Service]
WorkingDirectory=/home/pi/omi/agent
ExecStart=/home/pi/omi/agent/.venv/bin/uvicorn app:app --host 0.0.0.0 --port 9000
User=pi
Restart=always
RestartSec=2
ProtectSystem=full
ProtectHome=true
PrivateTmp=true
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable --now omiagent
ğŸ§© Endpoints principales
MÃ©todo	Ruta	DescripciÃ³n
GET	/v1/health	Estado y mÃ©tricas del dispositivo
PUT	/v1/identity	Asignar index y hostname
PUT	/v1/role	Cambiar rol activo
GET	/v1/services	Listar servicios
POST	/v1/services/{name}/{action}	Start/Stop/Restart de servicios
PUT	/v1/configs/{service}	Guardar configuraciÃ³n local
GET	/v1/logs/{name}	Ver logs del servicio
POST	/v1/power/{action}	reboot o shutdown

DocumentaciÃ³n interactiva disponible en
ğŸ§© http://<raspberry_ip>:9000/docs

ğŸ§  Permisos sudo
Permitir que el agente maneje servicios y energÃ­a sin pedir contraseÃ±a:

bash
Copiar cÃ³digo
echo "pi ALL=(ALL) NOPASSWD: /bin/systemctl, /usr/bin/journalctl, /usr/sbin/shutdown, /usr/sbin/reboot, /usr/bin/hostnamectl" | sudo tee /etc/sudoers.d/omiagent
ğŸ” Descubrimiento mDNS (Avahi)
Crea el archivo /etc/avahi/services/omiagent.service:

xml
Copiar cÃ³digo
<?xml version="1.0" standalone='no'?><!DOCTYPE service-group SYSTEM "avahi-service.dtd">
<service-group>
  <name replace-wildcards="yes">%h _omiagent</name>
  <service>
    <type>_omiagent._tcp</type>
    <port>9000</port>
    <txt-record>api=/v1</txt-record>
  </service>
</service-group>
Y reinicia Avahi:

bash
Copiar cÃ³digo
sudo systemctl restart avahi-daemon
ğŸ§ª Prueba rÃ¡pida
bash
Copiar cÃ³digo
curl http://localhost:9000/v1/health
O desde PowerShell (PC central):

powershell
Copiar cÃ³digo
Invoke-RestMethod http://omipi-01.local:9000/v1/health
ğŸ§­ Roles disponibles
Rol	Servicio(s) activado(s)	FunciÃ³n
standby	ninguno	Espera asignaciÃ³n
omimidi	omimidi.service	Convierte MIDI â†’ OSC
omiosc	omiosc.service	Controlador OSC
satellite	companion-satellite.service	Companion Satellite
companion	companion.service	Instancia principal de Companion

ğŸ§© Ejemplos de uso de la API
Cambiar rol
bash
Copiar cÃ³digo
curl -X PUT -H "Content-Type: application/json" \
  -d '{"role":"omimidi"}' \
  http://localhost:9000/v1/role
Ver logs de un servicio
bash
Copiar cÃ³digo
curl http://localhost:9000/v1/logs/omimidi
Apagar la Raspberry
bash
Copiar cÃ³digo
curl -X POST http://localhost:9000/v1/power/shutdown
ğŸ“œ Licencia
MIT Â© 2025 Omar Mohamed Luis
